<!DOCTYPE html>
<html lnag="ja">
  <head>
    <title>Yuki BBS 改造インスタンス by yoshikunTA</title>
    <meta charset="UTF-8">
    <script src="/UpSideDownToHTML/usdtohtml.js"></script>
    <style>
      :root {
        --light-bg: #fff;
        --light-fg: #000;
        --light-border-bg: transparent;
        --light-accent: #00f;
        --light-link-color: var("--light-accent");
        --light-button-bg: var("--light-accent");
        --light-button-fg: var("--light-bg");
        --dark-bg: #111;
        --dark-fg: #ddd;
        --dark-border-bg: transparent;
        --dark-accent: #0ff;
        --dark-link-color: var("--dark-accent");
        --dark-button-bg: var("--dark-bg");
        --dark-button-fg: var("--dark-fg");
        --link-hover: #0cf;
      }

      * {
        margin: 0;
      }
      
      .example4 {
        background: linear-gradient(
            to right,
            #c00,
            #cc0,
            #0c0,
            #0cc,
            #00c,
            #c0c,
          )
          0 / 200%;
        animation: 5s example4 linear infinite;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      @keyframes example4 {
        100% {
          background-position: 200%;
        }
      }

      .dark {
        background-color: var("--dark-bg");
        color: var("--dark-fg");
      }

      .dark input,
      .dark textarea,
      .dark select {
        background-color: var("--dark-bg");
        color: var("--dark-fg");
        border: #ddd 1px solid;
      }
      
      .dark button {
        background-color: var("--dark-button-bg");
        color: var("--dark-button-fg");
        border: #ddd 1px solid;
      }

      .dark a {
        color: var("--dark-link-color");
      }
      
      a:hover {
        color: var("--link-hover");
      }
      
      .menu, .submit_menu {
        display: none;
      }

      .menu.active, .submit_menu.active {
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <a href="javascript:var menu = document.querySelector('.menu'); menu.classList.toggle('active');" class="menu-toggle-button">メニュー</a>
    <div class="menu active">
      <label for="darkmode">ダークモード:</label>
      <input type="checkbox" id="darkmode" name="darkmode">
      <select name="font" id="font">
        <option value="serif" selected="">Serif</option>
        <option value="sans-selif">Sans Selif</option>
        <option value="Arial">Arial</option>
        <option value="Verdana">Verdana</option>
        <option value="Monospace">Monospace</option>
      </select>
    </div>
    <div class="example4"></div>
    <h1>Yuki BBS 改造インスタンス</h1>
    <br>
    <p>Yuki BBSの改造インスタンスです。</p>

    <form id="form">
      <select name="channel" id="channel">
        <option value="main" selected="">雑談</option>
        <option value="battle">バトルスタジアム</option>
      </select>
<a href="javascript:var submitMenu = document.querySelector('.submit_menu'); submitMenu.classList.toggle('active');">送信設定</a>
      <br>
      <div class="submit_menu active">
        <label for="name">名前</label>
        <input type="text" id="name" name="name" value="" maxlength="25" required="">
        <label for="seed">シード</label>
        <input type="text" id="seed" name="seed" value="" required="">
      </div>
      <br>
      <label for="message">メッセージ</label><br>
      <textarea name="message" rows="6" cols="100" maxlength="500" id="msg" required=""></textarea>
      <p></p>
      <button id="submit"　onclick="sendMessageByUser()">送信する</button>
<div class="submit_menu active">
        スピーカー以上のメッセージのみ表示
        <input type="checkbox" id="filter" name="verify">
</div>
      <br>
      <h2>投稿</h2>
    </form>

    <div id="messages"></div>
    <style>
      a{
        color:brown;
      }
      
    </style>
    <script>
      function autoLink(str) {
        var urlRegex = /(https?:\/\/[a-zA-Z0-9.\-_@:/~?%&;=+#',()*!]+)/g;
        return text.replace(urlRegex, function(url) {
          return '<a href="' + url + '">' + url + '</a>';
      });
    }

      function toLightmode() {
        $('body').css('background-color', 'white');
        $('#modal').css('background-color', 'white');
        $('textarea').css('background-color', 'white');
        $('input').css('background-color', 'white');
        $('body').css('color', 'black');
        $('button').css('color', 'black');
        $('textarea').css('color', 'black');
        $('input').css('color', 'black');
        $('a').css('color', 'black');
        $('textarea').css('border', '1px solid black');
        $('input').css('border', '1px solid black');
      }
      function toDarkmode() {
        $('body').css('background-color', 'black');
        $('#modal').css('background-color', 'black');
        $('textarea').css('background-color', 'black');
        $('input').css('background-color', 'black');
        $('body').css('color', 'white');
        $('button').css('color', 'white');
        $('textarea').css('color', 'white');
        $('input').css('color', 'white');
        $('a').css('color', 'white');
        $('textarea').css('border', '1px solid white');
        $('input').css('border', '1px solid white');
    }
      
    function sendMessage(name, seed, channel, message) {
  if (name=='' || seed=='' || channel=='' || message=='') {
    console.warn('Invalid argument(s).')
  } else {
    message = btoa(unescape(encodeURIComponent(message)));
    $.ajax({
      type: 'GET',
      url: '/bbs/result',
      data: {
        'name': name,
        'seed': seed,
        'message': message,
        'channel': channel
      }
    });  
    
    var xhr;
    function loadMessage() {
      if (xhr && xhr.readyState !== 4) { xhr.abort(); }
      
      var channel = document.getElementById('channel').value;
      var filter = document.getElementById('verify').checked;
      
      xhr = new XMLHttpRequest();
      xhr.open('GET', '/bbs/api', true);
      xhr.setRequestHeader('Content-Type', 'application/json');
    
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          var data = JSON.parse(xhr.responseText);
          var resultElement = document.getElementById('result');
          resultElement.innerHTML = data;
          
          // メッセージに対する操作の設定
          resultElement.querySelectorAll('table tr').forEach(function(row) {
            var number = row.querySelector('td:first-child').textContent;
            var username = row.querySelector('td:nth-child(2)').innerHTML;
            row.querySelector('td:first-child').innerHTML = '<button class="anchor" id="' + number + '">' + number + '</button>';
            row.querySelector('td:nth-child(2)').innerHTML = '<button class="userIDAnchor">' + username + '</button>';
          });
    
          // メッセージ内のリンク化とリプライの追加
          resultElement.querySelectorAll('*').forEach(function(node) {
            if (node.nodeType === 3) {
              var text = node.textContent;
              var replacedText = text.replace(/≫(\d+) /g, '<a href="#$1">$&</a>');
              var urlRegex = /(https?:\/\/[^\s]+)/g;
              if (urlRegex.test(text)) {
                replacedText = replacedText.replace(urlRegex, function(url) {
                  return '<a href="' + url + '">' + url + '</a>';
                });
              }
              node.replaceWith(replacedText);
            }
          });
    
          // リプライへのボタンクリック時の動作の設定
          resultElement.querySelectorAll('.anchor').forEach(function(button) {
            button.addEventListener('click', function() {
              var currentMsg = document.getElementById('message').value;
              document.getElementById('message').value = currentMsg + '≫' + button.textContent + ' ';
            });
          });
    
          // ユーザーIDへのボタンクリック時の動作の設定
          resultElement.querySelectorAll('.userIDAnchor').forEach(function(button) {
            button.addEventListener('click', function() {
              var currentMsg = document.getElementById('message').value;
              var cmdRegex = /^\/(dis)?speaker|manager|moderator$/g;
              if (currentMsg.match(cmdRegex)) {
                document.getElementById('message').value = currentMsg + ' ' + button.textContent;
              } else {
                document.getElementById('message').value = currentMsg + button.textContent;
              }
            });
          });
    
          // ダークモードの適用
          if (localStorage.getItem('darkmode') === 'true') { toDarkmode(); } else { toLightmode(); }
        }
      };
    
      xhr.send(JSON.stringify({ 'channel': channel, 'verify': filter, 't': 0 }));
    }
          var selectedChannel = localStorage.getItem('channel');
        if (selectedChannel) {
          $('#channel').val(selectedChannel);
        }
        
        $('#channel').change(function() {
          var newSelectedChannel = $(this).val();
          localStorage.setItem('channel', newSelectedChannel);
          loadMessage();
        });
      
        var isVerified = localStorage.getItem('verify') === 'true';
        $('#verify').prop('checked', isVerified);
      
        $('#verify').change(function() {
          var isVerified = $(this).prop('checked');
          localStorage.setItem('verify', isVerified.toString());
          loadMessage();
        });
      
        var storedName = localStorage.getItem('name');
        var storedSeed = localStorage.getItem('seed');
      
        if (storedName) {
          $('#name').val(storedName);
        }
        if (storedSeed) {
          $('#seed').val(storedSeed);
        }
        
        $('#name').on('input', function() {
          var newName = $(this).val();
          localStorage.setItem('name', newName);
        });
        $('#seed').on('input', function() {
          var newSeed = $(this).val();
          localStorage.setItem('seed', newSeed);
        });
      
          $('#openModal').click(function() {
          $('#modalOverlay').fadeIn(300);
          $('#modal').fadeIn(300);
        });
      
        $('#closeModal').click(function() {
          $('#modalOverlay').fadeOut(300);
          $('#modal').fadeOut(300);
        });
        
        var selectedFont = localStorage.getItem('font');
        if (selectedFont) {
          $('#font-select').val(selectedFont);
          $('body').css('font-family', selectedFont);
        }
        
        $('#font-select').change(function() {
          var newSelectedFont = $(this).val();
          localStorage.setItem('font', newSelectedFont);
          $('body').css('font-family', newSelectedFont);
        });
        
        var selectedFontSize = localStorage.getItem('font-size');
        if (selectedFontSize) {
          $('#font-size').val(selectedFontSize);
          $('body').css('font-size', `${selectedFontSize}px`);
          $('#font-size-val').text(`${selectedFontSize}px`);
        }
        
        $('#font-size').change(function() {
          var newFontSize = $(this).val();
          localStorage.setItem('font-size', newFontSize)
          $('body').css('font-size', `${newFontSize}px`);
          $('#font-size-val').text(`${newFontSize}px`);
        });
      
        var isDarkmode = localStorage.getItem('darkmode') === 'true';
        $('#darkmode').prop('checked', isDarkmode);
      
        $('#darkmode').change(function() {
          var isDarkmode = $(this).prop('checked');
          localStorage.setItem('darkmode', isDarkmode.toString());
          if (isDarkmode) { toDarkmode(); } else { toLightmode(); }
        });
        if (isDarkmode) { toDarkmode(); } else { toLightmode(); }
      
        loadMessage();
        setInterval(function() { loadMessage(); }, 5000);
      });


     
    </script>
  

</body>
</html>
