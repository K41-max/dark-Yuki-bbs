<!DOCTYPE html>
<html lang="ja">
<head>
  <title>Yuki BBS 改造インスタンス by yoshikunTA</title>
  <meta charset="UTF-8">
  <script src="/UpSideDownToHTML/usdtohtml.js"></script>
  <style>
    :root {
      --light-bg: #fff;
      --light-fg: #000;
      --light-border-bg: transparent;
      --light-accent: #00f;
      --light-link-color: var("--light-accent");
      --light-button-bg: var("--light-accent");
      --light-button-fg: var("--light-bg");
      --dark-bg: #111;
      --dark-fg: #ddd;
      --dark-border-bg: transparent;
      --dark-accent: #0ff;
      --dark-link-color: var("--dark-accent");
      --dark-button-bg: var("--dark-bg");
      --dark-button-fg: var("--dark-fg");
      --link-hover: #0cf;
    }

    * {
      margin: 0;
    }
    
    .example4 {
      background: linear-gradient(
          to right,
          #c00,
          #cc0,
          #0c0,
          #0cc,
          #00c,
          #c0c,
        )
        0 / 200%;
      animation: 5s example4 linear infinite;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    @keyframes example4 {
      100% {
        background-position: 200%;
      }
    }

    .dark {
      background-color: var("--dark-bg");
      color: var("--dark-fg");
    }

    .dark input,
    .dark textarea,
    .dark select {
      background-color: var("--dark-bg");
      color: var("--dark-fg");
      border: #ddd 1px solid;
    }
    
    .dark button {
      background-color: var("--dark-button-bg");
      color: var("--dark-button-fg");
      border: #ddd 1px solid;
    }

    .dark a {
      color: var("--dark-link-color");
    }
    
    a:hover {
      color: var("--link-hover");
    }
    
    .menu, .submit_menu {
      display: none;
    }

    .menu.active, .submit_menu.active {
      display: inline-block;
    }
  </style>
</head>
<body>
  <a href="#" onclick="toggleMenu()" class="menu-toggle-button">メニュー</a>
  <div id="menu" class="menu active">
    <label for="darkmode">ダークモード:</label>
    <input type="checkbox" id="darkmode" name="darkmode">
    <select name="font" id="font">
      <option value="serif" selected="">Serif</option>
      <option value="sans-serif">Sans Serif</option>
      <option value="Arial">Arial</option>
      <option value="Verdana">Verdana</option>
      <option value="Monospace">Monospace</option>
    </select>
  </div>
  <div class="example4"></div>
  <h1>Yuki BBS 改造インスタンス</h1>
  <br>
  <p>Yuki BBSの改造インスタンスです。</p>

  <form id="form">
    <select name="channel" id="channel">
      <option value="main" selected="">雑談</option>
      <option value="battle">バトルスタジアム</option>
    </select>
    <a href="#" onclick="toggleSubmitMenu()">送信設定</a>
    <br>
    <div id="submit-menu" class="submit_menu active">
      <label for="name">名前</label>
      <input type="text" id="name" name="name" value="" maxlength="25" required="">
      <label for="seed">シード</label>
      <input type="text" id="seed" name="seed" value="" required="">
    </div>
    <br>
    <label for="message">メッセージ</label><br>
    <textarea name="message" rows="6" cols="100" maxlength="500" id="message" required=""></textarea>
    <p></p>
    <button id="submit" onclick="sendMessageByUser()">送信する</button>
    <div id="filter-menu" class="submit_menu active">
      スピーカー以上のメッセージのみ表示
      <input type="checkbox" id="filter" name="verify">
    </div>
    <br>
    <h2>投稿</h2>
  </form>

  <div id="result"></div>

  <style>
    a {
      color: brown;
    }
  </style>

  <script>
    function toggleMenu() {
      var menu = document.getElementById('menu');
      menu.classList.toggle('active');
    }

    function toggleSubmitMenu() {
      var submitMenu = document.getElementById('submit-menu');
      submitMenu.classList.toggle('active');
    }

    function sendMessageByUser() {
      var name = document.getElementById('name').value;
      var seed = document.getElementById('seed').value;
      var message = document.getElementById('message').value;
      var channel = document.getElementById('channel').value;
      sendMessage(name, seed, channel, message);
      document.getElementById('message').value = "";
    }

    function loadMessage() {
      if (name=='' || seed=='' || channel=='' || message=='') {
    console.warn('Invalid argument(s).')
  } else {
    message = btoa(unescape(encodeURIComponent(message)));
        $.ajax({
          type: 'GET',
          url: '/bbs/result',
          data: {
            'name': name,
            'seed': seed,
            'message': message,
            'channel': channel
          }
        });
        console.log(message, btoa(message))
      }
    }

    function sendMessage(name, seed, channel, message) {
      var name = $('#name').val();
      var seed = $('#seed').val();
      var message = $('#message').val();
      var channel = $('#channel').val();
      sendMessage(name, seed, channel, message);
      $('#message').val("");
      }
    }
        var xhr;
    function loadMessage() {
      if (xhr && xhr.readyState !== 4) { xhr.abort(); }
      
      var channel = $('#channel').val();
      var filter = $('#verify').prop('checked');
      
      xhr = $.ajax({
        type: 'GET',
        url: '/bbs/api',
        headers: { 'Accept': null },
        xhrFields: {
          withCredentials: true
        },
        data: {
          'channel': channel,
          'verify': filter,
          't': 0
        },
        success: function(data) {
          $('#result').html(data);
          $('table tr').each(function() {
            var firstTd = $(this).find('td:first');
            var secondTd = $(this).find('td:eq(1)');
            var number = firstTd.text();
            var username = secondTd.html();
            firstTd.html(`<button class="anchor" id="${number}">${number}</button>`);
            secondTd.html(`<button class="userIDAnchor">${username}</button>`);
          });
          $("#result").find("*").contents().each(function() {
            if (this.nodeType === 3) {
              var text = $(this).text();
              var replacedText = text.replace(/≫(\d+) /g, "<a href='#$1'>$&</a>");
              var urlRegex = /(https?:\/\/[^\s]+)/g;
    　         if (urlRegex.test(text)) {
                replacedText = replacedText.replace(urlRegex, function(url) {
                  return '<a href="' + url + '">' + url + '</a>';
                });
              }
              $(this).replaceWith(replacedText);
            }
          });
          $('.anchor').click(function() {
            var currentMsg = $('#message').val();
            $('#message').val(currentMsg + '≫' + $(this).text() + ' ');
          });
          $('.userIDAnchor').click(function() {
            var currentMsg = $('#message').val();
            var cmdRegex = /^\/(dis)?speaker|manager|moderator$/g;
            if (currentMsg.match(cmdRegex)) { $('#message').val(currentMsg + ' ' + $(this).text()); } else { $('#message').val(currentMsg + $(this).text()); }
          });
          if (localStorage.getItem('darkmode') === 'true') { toDarkmode(); } else { toLightmode(); }
        }
      });
    }
    
    // ネットワークコネクション検知
    function updateConnectionStatus() {
      var status = $('#status');
      if (navigator.onLine) {
        status.removeClass('offline').addClass('online');
        status.text('online');
      } else {
        status.removeClass('online').addClass('offline');
        status.text('offline');
      }
    }
    
    $(document).ready(function() {
      updateConnectionStatus();
      window.addEventListener('online', updateConnectionStatus);
      window.addEventListener('offline', updateConnectionStatus);
    
      loadMessage();
      
      var selectedChannel = localStorage.getItem('channel');
      if (selectedChannel) {
        $('#channel').val(selectedChannel);
      }
      
      $('#channel').change(function() {
        var newSelectedChannel = $(this).val();
        localStorage.setItem('channel', newSelectedChannel);
        loadMessage();
      });
    
      var isVerified = localStorage.getItem('verify') === 'true';
      $('#verify').prop('checked', isVerified);
    
      $('#verify').change(function() {
        var isVerified = $(this).prop('checked');
        localStorage.setItem('verify', isVerified.toString());
        loadMessage();
      });
    
      var storedName = localStorage.getItem('name');
      var storedSeed = localStorage.getItem('seed');
    
      if (storedName) {
        $('#name').val(storedName);
      }
      if (storedSeed) {
        $('#seed').val(storedSeed);
      }
      
      $('#name').on('input', function() {
        var newName = $(this).val();
        localStorage.setItem('name', newName);
      });
      $('#seed').on('input', function() {
        var newSeed = $(this).val();
        localStorage.setItem('seed', newSeed);
      });
    
        $('#openModal').click(function() {
        $('#modalOverlay').fadeIn(300);
        $('#modal').fadeIn(300);
      });
    
      $('#closeModal').click(function() {
        $('#modalOverlay').fadeOut(300);
        $('#modal').fadeOut(300);
      });
      
      var selectedFont = localStorage.getItem('font');
      if (selectedFont) {
        $('#font-select').val(selectedFont);
        $('body').css('font-family', selectedFont);
      }
      
      $('#font-select').change(function() {
        var newSelectedFont = $(this).val();
        localStorage.setItem('font', newSelectedFont);
        $('body').css('font-family', newSelectedFont);
      });
      
      var selectedFontSize = localStorage.getItem('font-size');
      if (selectedFontSize) {
        $('#font-size').val(selectedFontSize);
        $('body').css('font-size', `${selectedFontSize}px`);
        $('#font-size-val').text(`${selectedFontSize}px`);
      }
      
      $('#font-size').change(function() {
        var newFontSize = $(this).val();
        localStorage.setItem('font-size', newFontSize)
        $('body').css('font-size', `${newFontSize}px`);
        $('#font-size-val').text(`${newFontSize}px`);
      });
    
      var isDarkmode = localStorage.getItem('darkmode') === 'true';
      $('#darkmode').prop('checked', isDarkmode);
    
      $('#darkmode').change(function() {
        var isDarkmode = $(this).prop('checked');
        localStorage.setItem('darkmode', isDarkmode.toString());
        if (isDarkmode) { toDarkmode(); } else { toLightmode(); }
      });
      if (isDarkmode) { toDarkmode(); } else { toLightmode(); }
    
      loadMessage();
      setInterval(function() { loadMessage(); }, 5000);
    });
  </script>
</body>
</html>
